<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Weapon Viewer Fixed</title>

<script type="module"
  src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js">
</script>

<style>
html, body {
    margin: 0;
    width: 100vw;
    height: 100vh;
    background: transparent !important;
    overflow: hidden;
    user-select: none;
}

#wrapper {
    position: absolute;
    inset: 0;
    pointer-events: none;
    transform-origin: center center;
}

.hidden {
    opacity: 0 !important;
}

model-viewer {
    width: 100%;
    height: 100%;
    background: transparent;
    --poster-color: transparent;
    pointer-events: auto;
}

/* 左上 m 完全削除 */
model-viewer::part(interaction-prompt) {
    display: none !important;
}
</style>
</head>

<body oncontextmenu="return false;" tabindex="0">

<div id="wrapper">
    <model-viewer
        id="knife"
        src="melee_156.glb"
        interaction-prompt="none"
        interaction-prompt-threshold="0"
        disable-zoom
        disable-tap
        shadow-intensity="0"
        field-of-view="45deg"
        camera-orbit="-30deg 80deg 70m">
    </model-viewer>
</div>

<script>
const wrapper = document.getElementById('wrapper');
const modelViewer = document.getElementById('knife');

let config = {
    posX: 0,
    posY: 0,
    orbitX: -30,
    orbitY: 80,
    distance: 70
};

let sway = { x: 0, y: 0, rotX: 0, rotY: 0 };
let isEditMode = false;
let lastX = 0, lastY = 0;
let dragL = false, dragR = false;
let idleTimer = null;

/* ===============================
   Message
=============================== */
window.addEventListener('message', (e) => {
    const d = e.data;
    if (d.type === 'set-mode') isEditMode = d.enabled;

    if (d.type === 'set-visible') {
        wrapper.classList.toggle('hidden', !d.visible);
    }

    if (d.type === 'update-transform') {
        sway.x = d.x;
        sway.y = d.y;
        sway.rotX = d.rotateX;
        sway.rotY = d.rotateY;
        updateTransform();
    }

    if (d.type === 'play-animation') {
        const anim = modelViewer.availableAnimations
            ?.find(a => a.toLowerCase().includes(d.name.toLowerCase()));
        if (anim) {
            modelViewer.animationName = anim;
            modelViewer.currentTime = 0;
            modelViewer.play();
        }
    }
});

/* ===============================
   Edit 操作
=============================== */
window.addEventListener('mousedown', (e) => {
    if (!isEditMode) return;
    lastX = e.clientX;
    lastY = e.clientY;
    if (e.button === 0) dragL = true;
    if (e.button === 2) dragR = true;
});

window.addEventListener('mouseup', () => {
    dragL = false;
    dragR = false;
});

window.addEventListener('mousemove', (e) => {
    if (!isEditMode) return;

    const dx = e.clientX - lastX;
    const dy = e.clientY - lastY;
    lastX = e.clientX;
    lastY = e.clientY;

    if (dragL) {
        config.posX += dx;
        config.posY += dy;
    }

    if (dragR) {
        config.orbitX -= dx * 0.5;
        config.orbitY -= dy * 0.5;
        config.orbitY = Math.max(1, Math.min(179, config.orbitY));
        modelViewer.setAttribute(
            'camera-orbit',
            `${config.orbitX}deg ${config.orbitY}deg ${config.distance}m`
        );
    }

    updateTransform();
});

/* ===============================
   Transform
=============================== */
function updateTransform() {
    wrapper.style.transform =
        `translate3d(${config.posX + sway.x}px, ${config.posY + sway.y}px, 0)
         rotateY(${sway.rotY}deg)
         rotateX(${sway.rotX}deg)`;
}

/* ===============================
   Idle モーション（たまに）
=============================== */
function playRandomIdle() {
    if (isEditMode) return;

    const idles = modelViewer.availableAnimations
        ?.filter(a => /idle|inspect/i.test(a)) || [];

    if (!idles.length) return;

    const anim = idles[Math.floor(Math.random() * idles.length)];
    modelViewer.animationName = anim;
    modelViewer.currentTime = 0;
    modelViewer.play();

    setTimeout(() => modelViewer.pause(), 1200);
}

function scheduleIdle() {
    clearTimeout(idleTimer);
    idleTimer = setTimeout(() => {
        playRandomIdle();
        scheduleIdle();
    }, 4000 + Math.random() * 6000);
}

modelViewer.addEventListener('load', () => {
    modelViewer.pause();
    scheduleIdle();
});
</script>
</body>
</html>
