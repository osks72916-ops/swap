<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Weapon Viewer Fixed</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <style>
        html, body {
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            background-color: transparent !important;
            overflow: hidden;
            user-select: none;
            outline: none;
        }
        #wrapper {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            transform-origin: center center;
        }
        .hidden { opacity: 0 !important; }
        model-viewer {
            width: 100%; height: 100%;
            background-color: transparent;
            --poster-color: transparent;
            pointer-events: auto;
        }
    </style>
</head>
<body oncontextmenu="return false;" tabindex="0">
    <div id="wrapper">
        <model-viewer
            id="knife"
            src="melee_156.glb"
            disable-zoom
            disable-tap
            interaction-prompt="none"
            shadow-intensity="0"
            autoplay
            field-of-view="45deg"
            camera-orbit="-30deg 80deg 50m"
        ></model-viewer>
    </div>
    <script>
        const wrapper = document.getElementById('wrapper');
        const modelViewer = document.getElementById('knife');

        let config = {
            posX: 0,
            posY: 0,
            orbitX: -30,
            orbitY: 80,
            distance: 70  // m
        };

        let sway = { x: 0, y: 0, rotX: 0, rotY: 0 };
        let isEditMode = false;
        let lastMouseX = 0, lastMouseY = 0, isDraggingLeft = false, isDraggingRight = false;

        // 初期 camera-orbit を確実に設定
        function applyOrbit() {
            const orbit = `${config.orbitX}deg ${config.orbitY}deg ${config.distance}m`;
            modelViewer.setAttribute('camera-orbit', orbit);
        }
        applyOrbit();

        window.addEventListener('message', (event) => {
            const data = event.data;
            if (!data) return;
            if (data.type === 'set-mode') {
                isEditMode = data.enabled;
                if (isEditMode) { window.focus(); }
            }
            if (data.type === 'set-visible') {
                if (data.visible) wrapper.classList.remove('hidden');
                else wrapper.classList.add('hidden');
            }
            if (data.type === 'update-transform') {
                sway.x = data.x; sway.y = data.y;
                sway.rotX = data.rotateX; sway.rotY = data.rotateY;
                updateTransform();
            }
            if (data.type === 'play-animation') {
                const foundAnim = modelViewer.availableAnimations?.find(a => a.toLowerCase().includes(data.name.toLowerCase()));
                if (foundAnim) {
                    modelViewer.animationName = foundAnim;
                    modelViewer.currentTime = 0;
                    modelViewer.play();
                }
            }
            if (data.type === 'wheel') {
                // 親から転送された wheel delta を使って距離を変更
                // 感度はここで調整（小さい値にするとよりゆっくり）
                const sensitivity = 0.05;
                config.distance += data.deltaY * sensitivity;
                config.distance = Math.max(10, Math.min(200, config.distance));
                applyOrbit();
            }
        });

        window.addEventListener('mousedown', (e) => {
            if (!isEditMode) return;
            lastMouseX = e.clientX; lastMouseY = e.clientY;
            if (e.button === 0) isDraggingLeft = true;
            if (e.button === 2) isDraggingRight = true;
        });

        window.addEventListener('mouseup', () => { isDraggingLeft = false; isDraggingRight = false; });

        window.addEventListener('mousemove', (e) => {
            if (!isEditMode) return;
            const deltaX = e.clientX - lastMouseX;
            const deltaY = e.clientY - lastMouseY;
            lastMouseX = e.clientX; lastMouseY = e.clientY;
            if (isDraggingLeft) {
                config.posX += deltaX; config.posY += deltaY;
            }
            if (isDraggingRight) {
                config.orbitX -= deltaX * 0.5; config.orbitY -= deltaY * 0.5;
                config.orbitY = Math.max(1, Math.min(179, config.orbitY));
                const orbit = `${config.orbitX}deg ${config.orbitY}deg ${config.distance}m`;
                modelViewer.setAttribute('camera-orbit', orbit);
            }
            updateTransform();
        });

        function updateTransform() {
            wrapper.style.transform = `translate3d(${config.posX + sway.x}px, ${config.posY + sway.y}px, 0) rotateY(${sway.rotY}deg) rotateX(${sway.rotX}deg)`;
        }
    </script>
</body>
</html>
