(function () {
    'use strict';

    const VIEWER_URL = "https://osks72916-ops.github.io/swap/view.html";

    /* ===============================
       iframe 作成
    =============================== */
    const iframe = document.createElement('iframe');
    Object.assign(iframe.style, {
        position: 'fixed',
        top: '0',
        left: '0',
        width: '100vw',
        height: '100vh',
        border: 'none',
        zIndex: '99999',
        pointerEvents: 'none',
        backgroundColor: 'transparent'
    });
    iframe.src = VIEWER_URL;
    document.body.appendChild(iframe);

    /* ===============================
       EDIT MODE 表示
    =============================== */
    const statusLabel = document.createElement('div');
    Object.assign(statusLabel.style, {
        position: 'fixed',
        top: '10%',
        left: '50%',
        transform: 'translateX(-50%)',
        color: '#00ff00',
        fontSize: '20px',
        fontWeight: 'bold',
        textShadow: '1px 1px 2px black',
        zIndex: '100000',
        display: 'none',
        pointerEvents: 'none',
        textAlign: 'center',
        background: 'rgba(0,0,0,0.5)',
        padding: '10px',
        borderRadius: '5px'
    });
    statusLabel.innerHTML =
        "=== EDIT MODE ===<br>" +
        "Left Drag: Move | Right Drag: Rotate<br>" +
        "Press [B] to Save";
    document.body.appendChild(statusLabel);

    /* ===============================
       状態
    =============================== */
    let isEditMode = false;
    let isVisible = true;
    let isMoving = false;

    // 視点追従（ラグ補正）
    let targetX = 0, targetY = 0;
    let smoothX = 0, smoothY = 0;
    let bobbingTime = 0;
    const LERP = 0.18;

    /* ===============================
       Message
    =============================== */
    window.addEventListener('message', (e) => {
        if (e.data?.type === 'toggle-mode-request') toggleEditMode();
    });

    /* ===============================
       Key
    =============================== */
    document.addEventListener('keydown', (e) => {
        // 表示切替
        if (e.code === 'Digit5') { setVisible(true); return; }
        if (['Digit1','Digit2','Digit3','Digit4'].includes(e.code)) {
            setVisible(false); return;
        }

        if (e.code === 'KeyB') { toggleEditMode(); return; }
        if (isEditMode) return;

        if (e.code === 'KeyQ' && isVisible) sendAnimation('Inspect');
        if (['w','a','s','d','W','A','S','D'].includes(e.key)) isMoving = true;
    });

    document.addEventListener('keyup', (e) => {
        if (['w','a','s','d','W','A','S','D'].includes(e.key)) {
            isMoving = false;
        }
    });

    /* ===============================
       Mouse
    =============================== */
    document.addEventListener('mousemove', (e) => {
        if (isEditMode) return;

        targetX += e.movementX * 0.3;
        targetY += e.movementY * 0.3;

        targetX = Math.max(-60, Math.min(60, targetX));
        targetY = Math.max(-60, Math.min(60, targetY));
    });

    document.addEventListener('mousedown', (e) => {
        if (!isEditMode && e.button === 0 && isVisible) {
            sendAnimation('Attack');
        }
    });

    /* ===============================
       Inventory チェック
    =============================== */
    function checkInventory() {
        if (isEditMode) return;

        const slots = document.querySelectorAll('.sc-lepLyc, div[class*="sc-lepLyc"]');
        if (slots.length < 3) return;

        const style = window.getComputedStyle(slots[2]);
        const selected =
            style.borderColor === 'rgb(255, 255, 255)' ||
            style.borderColor === '#ffffff';

        if (selected !== isVisible) setVisible(selected);
    }
    setInterval(checkInventory, 100);

    /* ===============================
       Control
    =============================== */
    function setVisible(v) {
        isVisible = v;
        iframe.contentWindow?.postMessage(
            { type: 'set-visible', visible: v }, '*'
        );
    }

    function toggleEditMode() {
        isEditMode = !isEditMode;
        iframe.style.pointerEvents = isEditMode ? 'auto' : 'none';
        statusLabel.style.display = isEditMode ? 'block' : 'none';

        iframe.contentWindow?.postMessage(
            { type: 'set-mode', enabled: isEditMode }, '*'
        );

        if (isEditMode) {
            iframe.focus();
            if (document.pointerLockElement) document.exitPointerLock();
        } else {
            window.focus();
        }
    }

    function sendAnimation(name) {
        iframe.contentWindow?.postMessage(
            { type: 'play-animation', name }, '*'
        );
    }

    /* ===============================
       Animate
    =============================== */
    function animate() {
        smoothX += (targetX - smoothX) * LERP;
        smoothY += (targetY - smoothY) * LERP;

        let bobX = 0, bobY = 0;
        if (isMoving && !isEditMode) {
            bobbingTime += 0.15;
            bobY = Math.sin(bobbingTime) * 15;
            bobX = Math.cos(bobbingTime * 0.5) * 8;
        }

        if (isVisible) {
            iframe.contentWindow?.postMessage({
                type: 'update-transform',
                x: -smoothX + bobX,
                y: -smoothY + bobY,
                rotateY: smoothX * 0.3,
                rotateX: -smoothY * 0.3
            }, '*');
        }

        requestAnimationFrame(animate);
    }

    iframe.onload = () => animate();
})();
